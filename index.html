<!DOCTYPE html>
<html lang="en"><!--è¯­è¨€ä¸ºè‹±è¯­-->

<head>
    <meta charset="UTF-8">
    <title>æ—¶é—´çš„æœ‹å‹|æ¨ç®±å­</title>
    <link href="images/favicon_books.ico" rel="shortcut icon">
    <link href="css/head.css" type="text/css" rel="stylesheet">
    <link href="css/default.css" type="text/css" rel="stylesheet">
    <link href="css/foot.css" type="text/css" rel="stylesheet">
    <link href="css/font-awesome.min.css" rel="stylesheet">

    <style>/*cssæ ·å¼è¡¨çš„è¡£æŸœ*/
		*{
			margin:0px;
			padding:0px;
		}
		body{
			overflow:hidden;
		}
		</style>
</head>

<body onkeydown="doKeyDown(event)">
    <!--é¡µå¤´-->
    <div class="head">
        <i class="fa fa-arrows" aria-hidden="true"></i> sokoban | æ¨ç®±å­
    </div>

    <div id='mybox'>
        <div class="banner">
            <a href="https://github.com/taketimeasafriend/sokoban" target="view_window" class="myButton"><i class="fa fa-github"></i> - Fork on Github - </a>
            <a href="http://ogudt6aal.bkt.clouddn.com/image/Wechat.png" target="view_window" class="myButton-weixin" onmouseover="this.className = 'myButton-weixin on';" onmouseout="this.className = 'myButton-weixin';">
                <i class="fa fa-usd"></i> - æ‰“èµ -
                <div class="weixin_nr">
                    <div class="arrow"></div>
                    <img src="images/Wechat.png" width="300" height="300" /> ğŸ™è°¢è°¢å°‘ä¾ ï¼Œæœ‰æœºä¼šè¯·ä½ åƒç”œç­’ğŸ¦
                </div>
            </a>
        </div>
        <div class="info">
            <h1>æ¨ç®±å­è¯´æ˜</h1>
            <ul>
                <li>ç”¨é”®ç›˜ä¸Šçš„ä¸Šã€ä¸‹ã€å·¦ã€å³é”®ç§»åŠ¨å°äººï¼ŒæŠŠç®±å­å…¨éƒ¨æ¨åˆ°å°çƒçš„ä½ç½®å³å¯è¿‡å…³ã€‚</li>
                <li>ç®±å­åªå¯å‘å‰æ¨ï¼Œä¸èƒ½å¾€åæ‹‰ã€‚</li>
                <li>ä¸€æ¬¡åªèƒ½æ¨åŠ¨ä¸€ä¸ªç®±å­ã€‚</li>
                <li>å…±100å…³ã€‚</li>
            </ul>
        </div>

        <div class="game">
          <canvas id="canvas" width="560" height="560"></canvas>
          <div id="msg"></div>
          <br>
          <div class="buttonbox">
            <input type="button" style="width: 80px" value="ä¸Šä¸€å…³" onClick="NextLevel(-1)">
            <input type="button" style="width: 80px" value="ä¸‹ä¸€å…³" onClick="NextLevel(1)">
            <input type="button" style="width: 80px" value="é‡ç©æœ¬å…³" onClick="NextLevel(0)">
          </div>
        </div>

    </div>

    <script src="js/mapdata100.js"></script>
    <script>
      var can = document.getElementById("canvas");
      var msg = document.getElementById("msg");
      var cxt = can.getContext("2d");
      var w = 35,h = 35;
      var curMap;//å½“å‰çš„åœ°å›¾
      var curLevel;//å½“å‰ç­‰çº§çš„åœ°å›¾
      var curMan;//åˆå§‹åŒ–å°äºº
      var iCurlevel = 0;//å…³å¡æ•°
      var moveTimes = 0;//ç§»åŠ¨äº†å¤šå°‘æ¬¡
      //é¢„åŠ è½½æ‰€æœ‰å›¾ç‰‡
      var oImgs = {
        "block" : "images/block.gif",
        "wall" : "images/wall.png",
        "box" : "images/box.png",
        "ball" : "images/ball.png",
        "up" : "images/up.png",
        "down" : "images/down.png",
        "left" : "images/left.png",
        "right" : "images/right.png",
      }
      function imgPreload(srcs,callback){
        var count = 0,imgNum = 0,images = {};

        for(src in srcs){
          imgNum++;
        }
        for(src in srcs ){
          images[src] = new Image();
          images[src].onload = function(){
            //åˆ¤æ–­æ˜¯å¦æ‰€æœ‰çš„å›¾ç‰‡éƒ½é¢„åŠ è½½å®Œæˆ
            if (++count >= imgNum)
            {
              callback(images);
            }
          }
          images[src].src = srcs[src];
        }
      }
      var block,wall,box,ball,up,down,left,right;
      imgPreload(oImgs,function(images){
        //console.log(images.block);
        block = images.block;
        wall = images.wall;
        box = images.box;
        ball = images.ball;
        up = images.up;
        down = images.down;
        left = images.left;
        right = images.right;
        init();
      });
      //åˆå§‹åŒ–æ¸¸æˆ
      function init(){
        //InitMap();
        //DrawMap(levels[0]);
        initLevel();//åˆå§‹åŒ–å¯¹åº”ç­‰çº§çš„æ¸¸æˆ
        showMoveInfo();//åˆå§‹åŒ–å¯¹åº”ç­‰çº§çš„æ¸¸æˆæ•°æ®
      }
      //ç»˜åˆ¶åœ°æ¿
      function InitMap(){
        for (var i=0;i<16 ;i++ )
        {
          for (var j=0;j<16 ;j++ )
          {
            cxt.drawImage(block,w*j,h*i,w,h);
          }
        }
      }
      //å°äººä½ç½®åæ ‡
      function Point(x,y){
        this.x = x;
        this.y = y;
      }
      var perPosition = new Point(5,5);//å°äººçš„åˆå§‹æ ‡å€¼
      //ç»˜åˆ¶æ¯ä¸ªæ¸¸æˆå…³å¡åœ°å›¾
      function DrawMap(level){
        for (var i=0;i<level.length ;i++ )
        {
          for (var j=0;j<level[i].length ;j++ )
          {
            var pic = block;//åˆå§‹å›¾ç‰‡
            switch (level[i][j])
            {
            case 1://ç»˜åˆ¶å¢™å£
              pic = wall;
              break;
            case 2://ç»˜åˆ¶é™·è¿›
              pic = ball;
              break;
            case 3://ç»˜åˆ¶ç®±å­
              pic = box;
              break;
            case 4://ç»˜åˆ¶å°äºº
              pic = curMan;//å°äººæœ‰å››ä¸ªæ–¹å‘ å…·ä½“æ˜¾ç¤ºå“ªä¸ªå›¾ç‰‡éœ€è¦å’Œä¸Šä¸‹å·¦å³æ–¹ä½å€¼å…³è”
              //è·å–å°äººçš„åæ ‡ä½ç½®
              perPosition.x = i;
              perPosition.y = j;
              break;
            case 5://ç»˜åˆ¶ç®±å­åŠé™·è¿›ä½ç½®
              pic = box;
              break;
            }
            //æ¯ä¸ªå›¾ç‰‡ä¸ä¸€æ ·å®½ éœ€è¦åœ¨å¯¹åº”åœ°æ¿çš„ä¸­å¿ƒç»˜åˆ¶åœ°å›¾
            cxt.drawImage(pic,w*j-(pic.width-w)/2,h*i-(pic.height-h),pic.width,pic.height)
          }
        }
      }
      //åˆå§‹åŒ–æ¸¸æˆç­‰çº§
      function initLevel(){
        curMap = copyArray(levels[iCurlevel]);//å½“å‰ç§»åŠ¨è¿‡çš„æ¸¸æˆåœ°å›¾
        curLevel = levels[iCurlevel];//å½“å‰ç­‰çº§çš„åˆå§‹åœ°å›¾
        curMan = down;//åˆå§‹åŒ–å°äºº
        InitMap();//åˆå§‹åŒ–åœ°æ¿
        DrawMap(curMap);//ç»˜åˆ¶å‡ºå½“å‰ç­‰çº§çš„åœ°å›¾
      }
      //ä¸‹ä¸€å…³
      function NextLevel(i){
        //iCurlevelå½“å‰çš„åœ°å›¾å…³æ•°
        iCurlevel = iCurlevel + i;
        if (iCurlevel<0)
        {
          iCurlevel = 0;
          return;
        }
        var len = levels.length;
        if (iCurlevel > len-1)
        {
          iCurlevel = len-1;
        }
        initLevel();//åˆå§‹å½“å‰ç­‰çº§å…³å¡
        moveTimes = 0;//æ¸¸æˆå…³å¡ç§»åŠ¨æ­¥æ•°æ¸…é›¶
        showMoveInfo();//åˆå§‹åŒ–å½“å‰å…³å¡æ•°æ®
      }
      //å°äººç§»åŠ¨
      function go(dir){
        var p1,p2;
        switch (dir)
        {
        case "up":
          curMan = up;
          //è·å–å°äººå‰é¢çš„ä¸¤ä¸ªåæ ‡ä½ç½®æ¥è¿›è¡Œåˆ¤æ–­å°äººæ˜¯å¦èƒ½å¤Ÿç§»åŠ¨
          p1 = new Point(perPosition.x-1,perPosition.y);
          p2 = new Point(perPosition.x-2,perPosition.y);
          break;
        case "down":
          curMan = down;
          p1 = new Point(perPosition.x+1,perPosition.y);
          p2 = new Point(perPosition.x+2,perPosition.y);
          break;
        case "left":
          curMan = left;
          p1 = new Point(perPosition.x,perPosition.y-1);
          p2 = new Point(perPosition.x,perPosition.y-2);
          break;
        case "right":
          curMan = right;
          p1 = new Point(perPosition.x,perPosition.y+1);
          p2 = new Point(perPosition.x,perPosition.y+2);
          break;
        }
        //è‹¥æœå°äººèƒ½å¤Ÿç§»åŠ¨çš„è¯ï¼Œæ›´æ–°æ¸¸æˆæ•°æ®ï¼Œå¹¶é‡ç»˜åœ°å›¾
        if (Trygo(p1,p2))
        {
          moveTimes ++;
          showMoveInfo();
        }
        //é‡ç»˜åœ°æ¿
        InitMap();
        //é‡ç»˜å½“å‰æ›´æ–°äº†æ•°æ®çš„åœ°å›¾
        DrawMap(curMap);
        //è‹¥æœç§»åŠ¨å®Œæˆäº†è¿›å…¥ä¸‹ä¸€å…³
        if (checkFinish())
        {
          alert("æ­å–œè¿‡å…³ï¼ï¼");
          NextLevel(1);
        }
      }
      //åˆ¤æ–­æ˜¯å¦æ¨æˆåŠŸ
      function checkFinish(){
        for (var i=0;i<curMap.length ;i++ )
        {
          for (var j=0;j<curMap[i].length ;j++ )
          {
            //å½“å‰ç§»åŠ¨è¿‡çš„åœ°å›¾å’Œåˆå§‹åœ°å›¾è¿›è¡Œæ¯”è¾ƒï¼Œè‹¥æœåˆå§‹åœ°å›¾ä¸Šçš„é™·è¿›å‚æ•°åœ¨ç§»åŠ¨ä¹‹åä¸æ˜¯ç®±å­çš„è¯å°±æŒ‡ä»£æ²¡æ¨æˆåŠŸ
            if (curLevel[i][j] == 2 && curMap[i][j] != 3 || curLevel[i][j] == 5 && curMap[i][j] != 3)
            {
              return false;
            }
          }
        }
        return true;
      }
      //åˆ¤æ–­å°äººæ˜¯å¦èƒ½å¤Ÿç§»åŠ¨
      function Trygo(p1,p2){
        if(p1.x<0) return false;//è‹¥æœè¶…å‡ºåœ°å›¾çš„ä¸Šè¾¹ï¼Œä¸é€šè¿‡
        if(p1.y<0) return false;//è‹¥æœè¶…å‡ºåœ°å›¾çš„å·¦è¾¹ï¼Œä¸é€šè¿‡
        if(p1.x>curMap.length) return false;//è‹¥æœè¶…å‡ºåœ°å›¾çš„ä¸‹è¾¹ï¼Œä¸é€šè¿‡
        if(p1.y>curMap[0].length) return false;//è‹¥æœè¶…å‡ºåœ°å›¾çš„å³è¾¹ï¼Œä¸é€šè¿‡
        if(curMap[p1.x][p1.y]==1) return false;//è‹¥æœå‰é¢æ˜¯å¢™ï¼Œä¸é€šè¿‡
        if (curMap[p1.x][p1.y]==3 || curMap[p1.x][p1.y]==5)
        {//è‹¥æœå°äººå‰é¢æ˜¯ç®±å­é‚£å°±è¿˜éœ€è¦åˆ¤æ–­ç®±å­å‰é¢æœ‰æ²¡æœ‰éšœç¢ç‰©(ç®±å­/å¢™)
          if (curMap[p2.x][p2.y]==1 || curMap[p2.x][p2.y]==3)
          {
            return false;
          }
          //è‹¥æœåˆ¤æ–­ä¸æˆåŠŸå°äººå‰é¢çš„ç®±å­å‰è¿›ä¸€æ­¥
          curMap[p2.x][p2.y] = 3;//æ›´æ”¹åœ°å›¾å¯¹åº”åæ ‡ç‚¹çš„å€¼
          //console.log(curMap[p2.x][p2.y]);
        }
        //è‹¥æœéƒ½æ²¡åˆ¤æ–­æˆåŠŸå°äººå‰è¿›ä¸€æ­¥
        curMap[p1.x][p1.y] = 4;//æ›´æ”¹åœ°å›¾å¯¹åº”åæ ‡ç‚¹çš„å€¼
        //è‹¥æœå°äººå‰è¿›äº†ä¸€æ­¥ï¼Œå°äººåŸæ¥çš„ä½ç½®å¦‚ä½•æ˜¾ç¤º
        var v = curLevel[perPosition.x][perPosition.y];
        if (v!=2)//è‹¥æœåˆšå¼€å§‹å°äººä½ç½®ä¸æ˜¯é™·è¿›çš„è¯
        {
          if (v==5)//å¯èƒ½æ˜¯5 æ—¢æœ‰ç®±å­åˆé™·è¿›
          {
            v=2;//è‹¥æœå°äººæœ¬èº«å°±åœ¨é™·è¿›é‡Œé¢çš„è¯ç§»å¼€ä¹‹åè¿˜æ˜¯æ˜¾ç¤ºé™·è¿›
          }else{
            v=0;//å°äººç§»å¼€ä¹‹åä¹‹å‰å°äººçš„ä½ç½®æ”¹ä¸ºåœ°æ¿
          }
        }
        //é‡ç½®å°äººä½ç½®çš„åœ°å›¾å‚æ•°
        curMap[perPosition.x][perPosition.y] = v;
        //è‹¥æœåˆ¤æ–­å°äººå‰è¿›äº†ä¸€æ­¥ï¼Œæ›´æ–°åæ ‡å€¼
        perPosition = p1;
        //è‹¥æœå°åŠ¨äº† è¿”å›true æŒ‡ä»£èƒ½å¤Ÿç§»åŠ¨å°äºº
        return true;
      }
      //åˆ¤æ–­æ˜¯å¦æ¨æˆåŠŸ
      //ä¸é”®ç›˜ä¸Šçš„ä¸Šä¸‹å·¦å³é”®å…³è”
      function doKeyDown(event){
        switch (event.keyCode)
        {
        case 37://å·¦é”®å¤´
          go("left");
          break;
        case 38://ä¸Šé”®å¤´
          go("up");
          break;
        case 39://å³ç®­å¤´
          go("right");
          break;
        case 40://ä¸‹ç®­å¤´
          go("down");
          break;
        }

      }
      //å®Œå–„å…³å¡æ•°æ®åŠæ¸¸æˆè¯´æ˜
      function showMoveInfo(){
        msg.innerHTML = "ç¬¬" + (iCurlevel+1) +"å…³ ç§»åŠ¨æ¬¡æ•°: "+ moveTimes;
      }
      //å…‹éš†äºŒç»´æ•°ç»„
      function copyArray(arr){
        var b=[];//æ¯æ¬¡ç§»åŠ¨æ›´æ–°åœ°å›¾æ•°æ®éƒ½å…ˆæ¸…ç©ºå†æ·»åŠ æ–°çš„åœ°å›¾
        for (var i=0;i<arr.length ;i++ )
        {
          b[i] = arr[i].concat();//é“¾æ¥ä¸¤ä¸ªæ•°ç»„
        }
        return b;
      }
    </script>
    <!--é¡µè„š-->
    <div class="foot">
        <a href="http://51world.win" target="view_window"><i class="fa fa-home"></i>ä¸»é¡µ</a> -
        <a href="https://github.com/taketimeasafriend" target="view_window"><i class="fa fa-github"></i>Github</a> -
        <a href="http://weibo.com/miaoxiaogege" target="view_window"><i class="fa fa-weibo"></i>å¾®åš</a> -
        <a href="http://ogudt6aal.bkt.clouddn.com/image/whynotwangwei.jpeg" target="view_window"><i class="fa fa-weixin"></i>å¾®ä¿¡</a> -
        <a href="mailto:taketimeasafriend@gmail.com?subject=I%20want%20to%20say%20&body=Hello%20"><i class="fa fa-envelope"></i>é‚®ç®±</a>
    </div>
</body>

</html>
